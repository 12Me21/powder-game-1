#include "menu.h"
#include "part.h"
#include <string.h>
#include <stdlib.h>
#include "elements.h"
#include <math.h>
#include "vector.h"
#include "entity.h"
#include <stdio.h>

static int number(char x) {
	if (x>='0' || x<='9')
		return x-48;
	return -1;
}

int saveDataArray[120000];
int saveMetaArray[120000];

void loadSaveString(char* data) {
	static char base64[] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,0,0,0,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,0};
	int version = number(data[0]);
	char* bgmode_str = "0123456789:;ABCDEF";
	char* index = strchr(bgmode_str, data[2]);
	int bgmode=-1;
	if (bgmode_str)
		bgmode = index-bgmode_str;
	if (bgmode==0)
		Menu_bgMode = 2;
	else if (bgmode!=-1)
		Menu_bgMode = bgmode-1;
	Menu_dotLimit = number(data[3]);
	Menu_gridSize = number(data[4]);
	Menu_gameSpeed = number(data[5]);
	Menu_edgeMode = number(data[6]);
	if (version==0) {
		Menu_carefully = 100;
		data += 8;
	} else if (version>=1) {
		Menu_carefully = base64[data[8]] | base64[data[9]]<<6;
		data += 16;
	}

	int* q[0x1000] = {0};
	int qSize[0x1000] = {0};
	int e[120000], eIndex=0, qIndex=1;
	for (; *data;) {
		int q_size=1;
		int q_read = base64[*data]<<6 | base64[data[1]];
		data+=2;
		if (q_read>0) {
			int i;
			for (i=0; i<qSize[q_read]; i++)
				e[eIndex++] = q[q_read][i];
			q_size = qSize[q_read]+1;
		}
		e[eIndex++] = base64[*data++];
		if (qIndex<0x1000) {
			if (q[qIndex]) {
				free(q[qIndex]);
				q[qIndex] = NULL;
			}
			q[qIndex] = malloc(sizeof(int)*q_size);
			qSize[qIndex] = q_size;
			int i;
			for (i=0; i<q_size; i++)
				q[qIndex][i]=e[eIndex-q_size+i];
			qIndex++;
		}
	}
	int i;
	for (i=0; i<0x1000; i++)
		if (q[i])
			free(q[i]);
	e[eIndex++] = 0;
	e[eIndex++] = 0;
	int a=0;
	int d;
	for (d=0; d<120000; ) {
		int b = e[a++];
		if (b==Elem_FAN || b==Elem_FIREWORKS || b==Elem_BOX || b==Elem_SAVE_BALL) {
			saveDataArray[d] = b;
			saveMetaArray[d++] = e[a++];
		} else if (b==Elem_PLAYER2) {
			saveDataArray[d] = Elem_PLAYER;
			saveMetaArray[d++] = e[a++];
		} else if (e[a]<48) {
			saveDataArray[d++] = b;
		} else {
			//1 or 2 digits in hexadecimal
			int w = e[a++]-48; //low nibble
			if (e[a]>=48) //if next digit
				w += (e[a++]-48)<<4; //get high nibble
			int i;
			for (i=0; i<w; i++)
				saveDataArray[d++] = b;
		}
	}
}

void load1(void) {
	int total=0;
	Part_reset(1);
	int x,y;
	for (y=0; y<300; y++) {
		for (x=0; x<400; x++) {
			int xy = 400*y+x;
			int t = saveDataArray[xy];
			switch (t) {
			when(0):
				xy=(y+8)*WIDTH+(x+8);
				Part_at[y+8][x+8] = Part_EMPTY;
			when(Elem_SAVE_BLOCK):
				Part_blocks[y/4+2][x/4+2].block = 1;
				Part_at[y+8][x+8] = Part_BLOCK;
			when(Elem_SAVE_WHEEL1):
				//Wheels.create(x+8,y+8);
			when(Elem_SAVE_WHEEL2):
				//Wheels.create(x+8,y+8);
			when(Elem_BOX):
				Entity_create(x+8,y+8,Elem_BOX,saveMetaArray[xy]);
			when(Elem_PLAYER):
				Entity_create(x+8,y+8,Elem_PLAYER2,saveMetaArray[xy]);
			when(Elem_SAVE_BALL):
				Ball_create(x+8, y+8, saveMetaArray[xy]);
			otherwise:
				total++;
				if (Menu_dotLimit<=0 && Part_LIMITS[0]<total)
					Menu_dotLimit=1;
				if(Menu_dotLimit<=1 && Part_LIMITS[1]<total)
					Menu_dotLimit=2;
				Part* a = Part_create(x+8, y+8, t);
				int meta = saveMetaArray[xy];
				if (t == Elem_FAN) {
					a->vel = (Vector){0.1*cos(meta*PI/32), 0.1*-sin(meta*PI/32)};
					Part_at[y+8][x+8] = Part_BGFAN;
				} else if (t == Elem_FIREWORKS)
					a->meta = meta;
			}
		}
	}
	Part_shuffle();
}

void Load_test(void) {
	char* data = "0010000000100*02102*01*03*06*05*01w00q00004000v00u01u0B*0200Du0F00Cv0E10E00Ku0J*0Hv0Lu0G*0Bv0Q00N10M*0Pu0O*0Su0X00I10V*0Y10b00au0R00e00Uu0fv0T*0W10dv0j*0cu0iu0Zv0m00g*0ku0o10lu0pu0v10u10xu0tu0z00h00**0s010*0n01200r*13*11*17*16*1901501Bv0qv1Du0wu0.*1801Cu1F014v1E10y01Ku1J*1Hv1Lu1G*1Av1Q01N11M*1Pu1O*1Su1X01I11V*1Y11b01au1R01e01Uu1fv1T*1W11dv1j*1cu1iu1Zv1m01g*1ku1o11lu1pu1v11u11xu1tu1z01h01**1s020*1n02201r*23*21*27*26*2902502Bv1qv2Du1wu1.*2802Cu2F024v1Q200t0B20Bs0020By2P000m00o2Pp0Bz2Rp00n2Rq2X20Br2Rr2bp2Yo2Ro2T22a20B.2Z00220Bo2R*0A10Mp2Y20Bp00p2Rm2ip2iq2ir2b22ap2d22ko2v000.2io2i*2mu2p20Bq2R22T02q232p2O237000s34o2k235o2W23923C02e22q02fp3323202f02Po3Lp2U00A23Iq3N02zr3B03Qp3Gp3Hp38036036p3Kp3Ko2N03A23Io3E03Up2vp3O23Ip3Uo3Sq3Pp3l23k23f23Is3oo3b03Zp3X03e03P.3103Zq3So3H03Mp2zo3gr3.23D23dp2o03Mo4303Zo2zp3Ho3Go3*p4D24C235r2vo4F03Z23L23Lr3go4M23Lo4B000r3g24Ko4523K04923W23Co4X04724O24403Mr4E04Q244o4Ip3*o4dr3**3yp46p4h20S23Gv3gp3*22g04Z03Zs4A24W04sp2Rs4i24rp4x23G24vr4N03wp4y04V04d24z24g24vp4do51r53p3gs4q03u24ro2lq0Jp4l24Wp3Yp3Ps4p24*04e04sq3n256040257036q5025Rp2Pq5No2Pr5W23pr5Vr5Y24K04er4Fr5823Cr4vo4124L23j05U03J036r5F20Gq5H24Up3*s2zs4u05425q03Mt3*r51p4m054p53r5*25d00D23Ls5u25l03w24v24rs6705E03Ms5A25V06Do51o3*v4jq5s03Q054o4226Gp5M03wo4dp5.24Yo48o5926U24Yr5wo4Pp6Qr4Po6304Zo5a03z25K25To6Qo6do5k03Zr6j26X04w25y*4k25t25J05223r25mp4.05P23po2go3do3h239q3S232o6*23Gr5Mo4T03V02M23527123R27A03ep6s06Mt5Q03a06Dp3Ep5mo3m244p6h05Eo7404Vp3Yo3S.3yr3zo2Yt2Ru00x0Jq6mo2Wt2Rv7Y11y23A00Dp2bo2Yn4xo4x.0Jo2Ry7a233n2Rt4c.7l27Fo3403Us3s078p7006gp3Cp3Y235p5124f04Jo3tp7tp3Po3Pt3Pq8726v07q10Mo5I02fo6or43o6i24bo6O05S04eo8Go6oo6V24ao5yp6Z24a03Zv2Y.7r06Mp6S26fo6k268o8Ip6W06H28Rp6Co8Is6dv8T18B27s25mr6nr5j28Z268p8bp8Yr3Gs4ds5Qr5i06500A.8Uq6dp5wp6Cp53o8a28m08c054s6xo3gv6Cz8hu3Gq6c28k27L28d24Fo8P25Ro9908co8G06R28o291p7c233.8Ur7208Jp8z239p7604H05os9T25h03M235q7Hs43p0Bt88p3ts5..7lw2b.0Jn00w7k10419l*0719m*01.0A30Bw2f10A00AD2Oo00A3310AH9ro00G01q33N9vL9xq00R9zQ9*X9zV9*02qc9co00aA2000y2T10M30Bu3M19tr00D33o9w04Q19tHAFo9.0A7r00NAJL2a19tRANQ0B19tXANVAVq33c9ZoAA0ALq2Qo7l39v22k19tsAI02ToAKsA7o00H9vGAgq2ON2yL2O19toA303Ao00QAo02TX9vVAws00c2yaArqAd12n3AJ22p19ttAim2TA9c19tpAm00AoAOpA7tAQ02So00LB8q2pRAJQB4q2pXAJVBK02Mc0Bm2TaBH0ACo7Z32y2ABuAi.2XAAF19tqBAo2TGBVN2hnBG00Lq33R2yQABq00X2yVBVcBdaBYqB1u2a3BPo2b19tvAiyBX00D1AHHBqGASq0SN2QnBevAPRBqQBy04QXBqVC2vA.0ACnAbvA7yADu2O3Bd2B009jD9rnAKwA7sBA.2XGCDwBEw2XL9r1AhRBdQCDsBj02.n00VCKcCFaCNqBo02M3B.2BRxAiuBuxBDHB.GCaNAFnBexBDRB.QBRtCRy2XVCacCga0BxC9o0Ju003CF2Bn0ACD2OnAKyA7uBAwCJ0Bf0ACNCwL2Q19tuAtw2XQCuuCRwCm0C*yC6s2XaD2qCXvCs00En7c19tzAiqBuzA7vBAuC.vA7zBEqCM000zDKRCgQ0S1BsXCgVDTq2Vc7oa2V19tyCA09j3Cw2CW02.D2knAK.A7wBAsC.wA7.BEoDP.DiRCwQDewCRsD8wDlcDga2h1Dao0JxDEq2ixA7*B6nAK*A7xBAqC.xD.NBPnBe*E1R7oQCp19txCRqD8xD.cE5a0G1Dw10MyDEo2iyA7m2XD2hAE51DaHDgGDC02SnBE.Bem2X1DaRDgQEQyCRoD8yEKnC6.AbmEUqCXzDEm2izA7nEL0ACA0BnEd0DQHE5GDZqEknBEyBenElzAtmD50DQ1DHXE5VEo02XnC6yAbnElyDb.DE.2R.AlnAiwAKoEl.CIGDvqDgN9rLDg19t.At.Av02.1FDX2hVF902TnC6wAboF0o0O32Q2EFq2pnCbAFR19t*BAyAO*A7p2XNAFLFTq0GR2QQFQ002X2QVFdp2XcAFaFa0BS10Mm2X39r2ENq7oD2OA7o19tm2XH9rGFo00AnBEsBeqElm2XR9rQFvm2XX9rVFvqFh03AaFrqCXnFm00E2Ep1AHnDIA2anEhnDLGGAqGDN33LGD19tnF.00EQGG0EzXAFVGNwDB04QnCq18BnDEs2enCHnAioAknF4H2OGFCqCwN2kLCw1AsnAtsFFoEloG103AVGc0GSc2paGfqCXpG8q2WnBDnAIA9cnFXnE2GFjtFYLGv1B9nAtqFFpElpGkqCT02qnGtcAbtFN10MqG8o7i1B5n9wDG.q7oH2kGG602MnBGNHE0FwR2kQHHqGkoH4qEltDBcHKyDbrFm2GJqCwA2kDGp0GSHAOrElsDPoFxnAPnA3QHV0GSXH4rHbnFMcHYyHTn2P3HgrBuqAirElrCJHHonFyNHtQAtrHrnCTXHtaAZ0GS1EGu7o22k3HNnAkDI3G2kHI3LAp0Fw1BZnGiRI3V2kXI3a2OcHHyDbp2t3FjpBuuAipH2nAOqBApIMLAFNIJnFFqAtpIMV33XIRaAFcFjyDbo2isEInF4A9rDGmoC.sBanF4L9rNIenFFsAtoGjnH4sEYnF4a9rcGmyDbn2iuDEnElnBuyAinIvnAOuBAnIyL2QNGNnEuuAtnIyVAFXJ1nAbyC6nH8uE529r3G0nDhDJCG9rHJCL2hNJCQ9rRJCV9rXJCa2hcFvyDb*7m3Fd*AKmEi*D.G2QHJRLE5NJRQ2QRJRV2QXJRaE5cFdyF122h3FJ.F6nBW1FDG2hHJhLFA0FGq2hQ2hRJhV2hXJhaDgcFJyDbz2rnDEzDNAFp0Evq2VGE5HEyzFynBEzDNQE5RK2VE5XK2a7ocEyyDbyGW3EXACwDEXGDgHEXLGd0AC1DaQDgREXVDgXEXaCwcEXoDx27o3E9qCpACgDKU07YGHF07dqCpLCgNKXxISnAtxE1V7oXKdaCgcKXyDbw4xnDEwDiACFDDqGCwHDqLCFNDqQCwRDqVCwXDqaCFcDeyDbv7XnDEvDKAB.DDW00DGCgHL4vBeyFY0Bvq0SQCgRL7VCgXL7aB.cL4yDbu2RwG8uCyABdDD6GCFHD6LBdND6QCFRD6VCFXD6aBdcCuyDbt7mnDEtBDABqDCkGB.HCkLBqNCkQB.RCkVB.XCkaBqcBRyDbsF3nGV1AhA2yDCQGBdHCQL2yNCQQBdRCQVBdXCQa2ycCDyHT2Bq3C2rAKq2TDM4GBqHM4LAJNM4QBqRM4VBqXM4aAJcC2yDbq2eoDy1BZA9vDBiG2yHBiL9vNBiQ2yRBiV2yXBia9vcAByIH2AJ3BNpAKuM602q1B9GAJHMaLANNMaQAJRMaVAJXMaaANcBNyIZ29v3AwoCGoGY1AsG9vHMrL9zNMrQ9vRMrV9vXMra9zcAwyDb2AN3AY0CxoAi19tGANHN5LAdNN5QANRN5VANXN5aAdcN5yCA29z39*A2hoAI10AG9zH9*LNMN9*Q9zR9*V9zX9*aNMcGT*9n*NZ*0812.q0059z4A7q00800O9v7A2FLJo00ENfK9vJA2P9zO9*T9zSNfZ9vYA2f9zd0J5AN4N5rNgOAJ7C2F7XoNl0APKAJJC2PANON5TANSNyZAJYC2fANdAVu2k59v4Az8Nh0Aj7CDo00F7jEAzK2yJOIP9vOMrT9vSAzZ2yYOIf9vdAgu2p5AJ4BNtNz0BF7BRpOJ2AJEOYKBqJObPAJOMaTAJSOYZBqYObfAJdB4u3352y4BV800MBd7CuqOc0AjEBVKBdJOuP2yOBiT2ySBVZBdYOuf2yd9xu2a5Bq4C58Os0C77L4rOvm2TEC5KB.JPBPBqOM4TBqSC5ZB.YPBfBqdASu2O5Bd4CK8OGw2X7DesOv.2XECKKCFJPUPBdOCQTBdSCKZCFYPUfBddAru9c5B.4Ca8OGuPT0Ka02MFLZECaKCgJKXt00PB.OCkTB.SCaZCgYPsfB.dB8uAF5CF4LX8OGsPmyCyFLJnO1uC9KCwJEQuPt09jnPl1D3TCFSLXZCwYQAfCFdBYu0S5Cg4L4zOZqPmzDKFL0EQNK7oJEyvQBu2XOL7TCgSQNZ7oYQUfCgdDTu9r5Cw4De.NgMDg7FJwOvsPW09j1FDKDgJQjPCwODqTCwSQgZDgYQjfCwdCNuCp57o4KX*Qh0ER7FdxOvqQlxD.KE5JR1P7oOKdT7oSQ.ZE5YR1f7odE9u2Q5Dg4EQm2X8P9.007JOFGWERHn00K2hJJOPDgOEXTDgSRNZ2hYJOfDgdD2u2V5E54EynRIM2Q7GNzPCnO1zGEK2QJRePE5OK2TE5SRbn00Z2QYRefE5dDZu2h52h4FJoRc09j7Gm.PVERvnRO09jJRyP2hOJhT2hSR.Z9rYRyf2hdDvu0G52Q4FgnQ*uRK0H51FUF7mESCKAFJFj*QByOG*D.T2QSSCZAFYSKf2QdEFuE559r4G3nQ*sSEqFznOvwO1mElq2XK2OJHHm2XP9rOJCT9rSSWZ2OYSfn00f9rdENuEp5AF4GNrRwqSErIyF7XESsnR*q00JHgnSg00EOJ6TAFSSxZ33YS.nSn00EdGAuDg52O4GmsRwoSEsImF4xETBnR*oSz03AnF4P2OOIjT2OSTGZ2kYHYo2Xf2OdFCuFR5334GynQh7HKp2XF2YETWKTItIMP33OIRT33STWZ00YTYnT6q00dFTu7o52k4HHtPT8OGtScnOvoO1qHQnSzKHKqS*oOGqTsT2kSTpnTiZTxnT6oTl0I9uGD5004HgsPmoOZsHxF2PEU8nTIoR*sHxPOGrHxT00SUDY2kZHYrTRdGJuGD4Nd0H*qGD7338UHnHeEOvrHxJ33KHtOQBrHxS00THtY33ZHtdT6rEUuQz02T5I372O8TznNfnO1oR2nUnJ2OKI3O2kPI3S2kTI3Y2OZI3d2kfFruFR4Op0SFqFR7AF8P9pIME33FGs1G*JAFKIRO33PIRS33TIRYAFZIRd33fTm0FK4PP0FK1Gg79r8P9oImE2OFGW1GgJ9rKIjO2OPIjS2OTIjY9rZIjd2OfTT0Ez4Q00Ez1GKnSEyOZnIyEAFF2RnIyJ2QKJ6OAFPJ6SAFTJ6Y2QZJ6dAFfT80ER4Qe0ER1FsnSE.OZmSZE9rFJx1V.J2hKJCO9rPJCS9rTJCY2hZJCd9rfSp0024RF003q0G7E58SM1FUE2QF2l1FUJE5KJRO2QPJRS2QTJRYE5ZJRd2QfST02.4Rt0Jo02.7Dg8RJ1FDE2hFF31FDJDgKJhO2hPJhS2hTJhYDgZJhd2hfS90DQ4SU0J*0DQ77o8P9zDNEE5F2RzDNJ7oKK2OE5PK2SE5TK2Y7oZK2dE5fRs0AC4T90KKqRd0TJ8P9yC9EDgF7m1DaJCwKEXODgPEXSDgTEXYCwZEXdDgfRY07Y4Tn0PnxSEuRILKdE7oF2RxE1JCgKKdO7oPKdS7oTKdYCgZKdd7ofRE09j4Cw5Dq7CF8R*wDiECwFLJ19twTIwSd0QmqSh0TJPDqSCwTDqYCFZDqdCwfQx00D4Cg5L77B.8TIvDKECgFDGq0SJB.KL7OCgPL7SCgTL7YB.ZL7dCgfQd00E4CF5D67Bd800ID6ECFF7X1D3JBdKD6OCFPD6SCFTD6YBdZD6dCFfQK02M4B.5Ck7Bq8BAtBDEB.F7p1B5JBqKCkOB.PCkSB.TCkYBqZCkdB.fP*03A4Bd5CQ72y8OJ03A1AhEBdF4x1AhJ2yKCQOBdPCQSBdTCQY2yZCQdBdfPh04Q4Bq5M47AJ8Hq1AHEBqFBrq2aJAJKM4OBqPM4SBqTM4YAJZM4dBqfPO00A42y5Bi79v8M51BZE2yF2Y1BZJ9vKBiO2yPBiS2yTBiY9vZBid2yfP502q4AJ5Ma7AN8SEpFXEAJF2W1B9JANKMaOAJPMaSAJTMaYANZMadAJfOo02T49v5Mr79z8U70ADq2kE9vF2e1AsJ9zKMrO9vPMrS9vTMrY9zZMrd9vfOV0aHuUj0A77Ad82R19tEANFabq0BJAdKN5OANPN5SANTN5YAdZN5dANfOC49z59*7NM8AYE9zF2P10AJNMK9*O9zP9*S9zT9*YNMZ9*d9zfNb*Na19o19jq";
	loadSaveString(data);
	load1();
}
